<cite>
**本文档中引用的文件**   
- [config.h](file://include/linux/config.h)
- [head.s](file://boot/head.s)
- [hd.c](file://kernel/hd.c)
- [hdreg.h](file://include/linux/hdreg.h)
</cite>

## 目录
1. [内核配置详解](#内核配置详解)
2. [HIGH_MEMORY宏与内存上限](#high_memory宏与内存上限)
3. [BUFFER_END宏与缓冲区布局](#buffer_end宏与缓冲区布局)
4. [ROOT_DEV宏与根设备指定](#root_dev宏与根设备指定)
5. [HD_TYPE宏与硬盘参数](#hd_type宏与硬盘参数)
6. [配置修改案例与风险](#配置修改案例与风险)

## 内核配置详解

Linux 0.01内核的配置系统通过`include/linux/config.h`文件中的预处理器宏来定义关键的系统参数。这些宏在编译时被解析，决定了内核的行为和硬件兼容性。核心配置包括内存布局、根文件系统设备和硬盘物理参数。这些设置必须与实际硬件精确匹配，否则将导致系统无法启动或数据损坏。配置文件通过条件编译（`#if defined(LINUS_HD)`）支持不同的硬件配置，如Linus Torvalds的原始开发环境（LINUS_HD）。

**Section sources**
- [config.h](file://include/linux/config.h#L1-L54)

## HIGH_MEMORY宏与内存上限

`HIGH_MEMORY`宏定义了系统可用的物理内存上限，其值以字节为单位。在`config.h`中，当定义`LINUS_HD`时，`HIGH_MEMORY`被设置为`0x800000`，即8MB。此值并非随意设定，而是与`boot/head.s`中的页目录项数量直接关联。在`head.s`的`setup_paging`函数中，代码通过循环初始化页目录项来建立内存映射。该循环的次数和页表的布局决定了内核能够管理的最大内存。如果`HIGH_MEMORY`设置得过大，而页目录项数量不足，超出部分的内存将无法被寻址和使用。因此，增加内存上限必须同步修改`head.s`中的页表初始化逻辑，以确保有足够的页目录项来映射新增的内存区域。

**Section sources**
- [config.h](file://include/linux/config.h#L15-L18)
- [head.s](file://boot/head.s#L120-L150)

## BUFFER_END宏与缓冲区布局

`BUFFER_END`宏定义了内核缓冲区内存的结束地址，其计算逻辑直接依赖于`HIGH_MEMORY`的值。根据`config.h`中的条件编译，如果`HIGH_MEMORY`大于或等于`0x600000`（6MB），则`BUFFER_END`被设置为`0x200000`（2MB）；否则，它被设置为`0xA0000`（640KB）。这个宏对缓冲区内存布局有决定性影响。缓冲区用于临时存储从块设备（如硬盘）读取的数据。`BUFFER_END`的值必须是4096字节对齐的，并且不能与内核代码、数据或高端内存区域重叠。将`BUFFER_END`设置为`0xA0000`是为了避开传统的640KB-1MB的“上位内存”（Upper Memory）区域，而设置为`0x200000`则允许在内存充足的系统上使用更大的缓冲区，从而提高I/O性能。

**Section sources**
- [config.h](file://include/linux/config.h#L21-L26)

## ROOT_DEV宏与根设备指定

`ROOT_DEV`宏在系统启动时指定根文件系统所在的设备。其值是一个16位的设备号，由主设备号和次设备号组成。在`config.h`中，对于`LINUS_HD`配置，`ROOT_DEV`被定义为`0x306`。这个十六进制数可以分解为：高8位`0x3`是主设备号，代表硬盘（HD）；低8位`0x06`是次设备号。次设备号编码了具体的硬盘和分区信息。根据Linux 0.01的约定，次设备号的计算方式为：`minor = (drive_number * 5) + partition_number`。因此，`0x06`表示`drive_number=1`（第二个硬盘）和`partition_number=1`（第一个分区），即第二个IDE硬盘的第一个分区。

### 常见设备号对照表

| 设备号 (十六进制) | 硬盘 (Drive) | 分区 (Partition) | 描述 |
| :--- | :--- | :--- | :--- |
| 0x301 | 0 | 1 | 第一个硬盘，第一个分区 |
| 0x302 | 0 | 2 | 第一个硬盘，第二个分区 |
| 0x305 | 0 | 5 | 第一个硬盘，第五个分区 (扩展) |
| 0x306 | 1 | 1 | 第二个硬盘，第一个分区 |
| 0x307 | 1 | 2 | 第二个硬盘，第二个分区 |

该宏在`fs/super.c`的`mount_root()`函数中被使用，以挂载根文件系统。

**Section sources**
- [config.h](file://include/linux/config.h#L28-L31)
- [super.c](file://fs/super.c#L69-L75)

## HD_TYPE宏与硬盘参数

`HD_TYPE`宏定义了一个或多个硬盘的物理参数结构体，其数据结构在`include/linux/hdreg.h`中定义。每个结构体包含六个字段：`{ HEAD, SECTOR, TRACKS, WPCOM, LZONE, CTL }`，它们直接映射到硬盘的物理特性。

```c
#define HD_TYPE { 5,17,980,300,980,0 },{ 5,17,980,300,980,0 }
```

### 字段含义详解

- **HEAD (磁头数)**: `5`。表示硬盘有5个读写磁头，对应5个盘面。这是计算总柱面数和寻址的关键参数。
- **SECTOR (每磁道扇区数)**: `17`。表示每个磁道被划分为17个扇区。这是CHS（柱面-磁头-扇区）寻址的基础。
- **TRACKS (总柱面数)**: `980`。表示硬盘共有980个柱面。柱面是所有盘面上相同半径的磁道的集合。
- **WPCOM (写前补偿柱面)**: `300`。这是一个优化参数，表示从第300个柱面开始，需要调整写入电流以补偿高频信号衰减。在`hdreg.h`中，此值被右移2位（除以4）后使用。
- **LZONE (着陆区柱面)**: `980`。通常设置为最大柱面数，表示磁头在断电时应停靠的位置，以保护盘片。
- **CTL (控制标志)**: `0`。根据注释，对于少于8个磁头的驱动器应为0，多于等于8个磁头时为8。其具体硬件含义在当时并不明确。

这些参数在`kernel/hd.c`中被静态初始化为`hd_info`数组，供硬盘驱动程序在读写操作时使用。

**Section sources**
- [config.h](file://include/linux/config.h#L39-L45)
- [hdreg.h](file://include/linux/hdreg.h#L10-L28)
- [hd.c](file://kernel/hd.c#L28-L30)

## 配置修改案例与风险

修改`config.h`中的参数是一个高风险操作，必须基于对硬件的精确了解。

### 修改案例

**案例1：增加内存支持**
假设要将系统内存从8MB扩展到16MB，需要将`HIGH_MEMORY`修改为`0x1000000`。但这必须同步修改`boot/head.s`，增加页目录和页表的数量，否则超出8MB的内存将无法被使用。

**案例2：更换硬盘**
如果更换为一个每磁道20个扇区的硬盘，必须将`HD_TYPE`中的`SECTOR`字段从`17`改为`20`。否则，内核将使用错误的扇区数进行寻址，导致读写错误。

### 风险警告

- **启动失败**: 错误的`ROOT_DEV`会导致内核无法找到根文件系统，从而在`mount_root()`时`panic`。
- **数据损坏**: 错误的`HD_TYPE`参数（如`SECTOR`或`TRACKS`）会导致内核向硬盘发出错误的CHS寻址命令，可能覆盖其他分区的数据或破坏文件系统。
- **系统不稳定**: 不正确的`HIGH_MEMORY`或`BUFFER_END`可能导致内存区域重叠，引发不可预测的内存访问错误和系统崩溃。

因此，在修改任何配置宏之前，务必查阅硬件手册并充分理解其影响。

**Section sources**
- [config.h](file://include/linux/config.h#L1-L54)
- [head.s](file://boot/head.s#L120-L150)
- [hd.c](file://kernel/hd.c#L28-L30)