# 构建环境要求

<cite>
**本文档中引用的文件**  
- [Makefile](file://Makefile)
- [kernel/Makefile](file://kernel/Makefile)
- [fs/Makefile](file://fs/Makefile)
- [mm/Makefile](file://mm/Makefile)
- [lib/Makefile](file://lib/Makefile)
- [boot/boot.s](file://boot/boot.s)
- [tools/build.c](file://tools/build.c)
- [include/linux/config.h](file://include/linux/config.h)
- [NOTES.md](file://NOTES.md)
- [README](file://README)
</cite>

## 目录
1. [简介](#简介)
2. [编译器要求](#编译器要求)
3. [GNU Binutils 工具链配置](#gnu-binutils-工具链配置)
4. [32位编译环境](#32位编译环境)
5. [构建工具依赖与安装](#构建工具依赖与安装)
6. [常见环境问题排查](#常见环境问题排查)
7. [结论](#结论)

## 简介
Linux-0.01 是林纳斯·托瓦兹于1991年发布的首个公开内核版本，其构建环境与现代系统存在显著差异。该内核必须在特定的工具链和配置下才能成功编译。本文档详细说明了构建 Linux-0.01 所需的完整环境，包括编译器版本、汇编器与链接器配置、32位模式要求以及在现代系统上的适配方法。核心挑战在于现代工具链的默认安全特性与旧版内核代码的不兼容性，必须通过特定编译标志进行禁用。

## 编译器要求
构建 Linux-0.01 内核对编译器有严格要求。原始文档明确指出使用 **GCC 1.40** 版本进行编译。然而，在现代系统上，直接使用如此古老的编译器已不现实。因此，实践中的解决方案是使用兼容的现代 GCC 版本（如 `gcc-4.8`），并配合一系列关键的编译选项来模拟旧版编译器的行为。

从项目根目录的 `Makefile` 中可以明确看到编译器的配置：
```makefile
CC	=gcc-4.8
CFLAGS	=-Wall -O -std=gnu89 -fstrength-reduce -fomit-frame-pointer -fno-stack-protector -fno-builtin -g -m32
```

这些编译标志至关重要，原因如下：

- **`-fno-stack-protector`**: 现代 GCC 默认启用栈保护（Stack Smashing Protector）来防止缓冲区溢出攻击。然而，Linux-0.01 的代码并未为此设计，且其低层汇编代码（如 `boot/boot.s`）直接操作栈，会触发栈保护机制，导致编译失败或运行时崩溃。此标志必须禁用该安全特性。
- **`-fno-builtin`**: GCC 会将某些标准库函数（如 `memcpy`, `strlen`）识别为内建函数并进行优化。Linux-0.01 的代码库中包含了这些函数的自定义实现（如 `lib/string.c`），若不使用此标志，编译器可能会生成调用内建函数的代码，从而破坏内核的预期行为。
- **`-std=gnu89`**: 指定使用 GNU C89 标准，确保语法兼容性。
- **`-fstrength-reduce` 和 `-fomit-frame-pointer`**: 这些是原始 GCC 1.40 中常用的优化选项，用于生成更小、更高效的代码，符合当时对内核大小的限制。

**Section sources**
- [Makefile](file://Makefile#L15-L16)
- [README](file://README#L35-L38)

## GNU Binutils 工具链配置
除了编译器，GNU Binutils 工具链（汇编器 `as` 和链接器 `ld`）的版本和配置同样关键。Linux-0.01 的 `Makefile` 明确指定了交叉编译工具链的使用：

```makefile
AS	=i686-linux-gnu-as
LD	=i686-linux-gnu-ld
```

这表明必须使用为 `i686` 架构（32位 x86）设计的交叉编译工具。直接使用系统自带的 `as` 和 `ld` 可能会导致目标架构不匹配或生成不兼容的二进制文件。

在 `Makefile` 中，还定义了用于 16 位引导代码的专用工具：
```makefile
AS86	=i686-linux-gnu-as -0 -a
LD86	=i686-linux-gnu-ld -0
```
这里的 `-0` 选项是 `as86` 和 `ld86`（用于 16 位代码的传统工具）的标志，但这里被重定向到 `i686-linux-gnu-as` 和 `i686-linux-gnu-ld`。这要求现代的 `binutils` 能够兼容这些旧的汇编和链接选项，以正确处理 `boot/boot.s` 中的 16 位实模式代码。

**Section sources**
- [Makefile](file://Makefile#L12-L13)
- [Makefile](file://Makefile#L10-L11)

## 32位编译环境
Linux-0.01 是一个纯 32 位内核，其代码和内存布局都基于 32 位地址空间设计。因此，必须在 32 位模式下进行编译。

在 `Makefile` 的 `CFLAGS` 中，`-m32` 标志被明确使用：
```makefile
CFLAGS	=... -m32
```
这个标志强制 GCC 生成 32 位的 x86 代码。在现代 64 位系统上，如果没有这个标志，编译器默认会生成 64 位代码，这将与内核中硬编码的 32 位内存地址和寄存器操作完全不兼容，导致链接失败或内核无法启动。

要在现代 64 位系统上配置此环境，除了安装 `gcc-4.8`，还必须安装支持 32 位目标的交叉编译工具链，例如 `gcc-4.8-multilib` 或 `gcc-4.8-i686-linux-gnu`，以确保 `-m32` 标志能够正常工作。

**Section sources**
- [Makefile](file://Makefile#L16)
- [fs/Makefile](file://fs/Makefile#L6)

## 构建工具依赖与安装
成功构建 Linux-0.01 需要以下核心工具：

1.  **GCC 4.8 或兼容版本**: 用于 C 代码编译。
2.  **i686-linux-gnu-binutils**: 包含 `i686-linux-gnu-as` 和 `i686-linux-gnu-ld`。
3.  **make**: 构建系统。
4.  **chmem**: 用于调整 `tools/build` 程序的内存限制（在 `Makefile` 中有 `chmem +65000 tools/build` 命令）。

在基于 Debian/Ubuntu 的系统上，可以通过以下命令安装这些依赖：

```bash
# 安装 GCC 4.8 (如果系统默认版本不是4.8)
sudo apt-get install gcc-4.8 g++-4.8

# 安装 i686 架构的交叉编译工具链
sudo apt-get install gcc-4.8-multilib

# 安装 chmem 工具 (通常包含在 util-linux 或 sysvinit-utils 包中)
sudo apt-get install util-linux

# 确保 make 已安装
sudo apt-get install make
```

`NOTES.md` 文件中的研发环境记录也证实了这一点：
```
## R&D Env
* Debian 10 (buster) Amd64
* GCC: 4.8.4-1
* Binutils: 2.31.1-16
```

**Section sources**
- [Makefile](file://Makefile#L15-L16)
- [Makefile](file://Makefile#L90)
- [NOTES.md](file://NOTES.md#L4-L7)

## 常见环境问题排查
在构建过程中，可能会遇到以下典型问题：

### 汇编语法不兼容
当使用不兼容的汇编器时，`boot/boot.s` 中的 16 位汇编指令可能会报错。例如，`outb` 指令的语法可能不被识别。确保使用 `i686-linux-gnu-as` 并检查其版本。如果问题依旧，可能需要手动修改 `boot/boot.s` 中的指令，例如将 `outb` 改为 `outb %al, %dx` 的完整形式。

### 链接器版本冲突
`tools/build` 程序是一个关键的链接后处理工具，它负责将 `boot` 引导扇区和 `system` 内核映像合并成最终的 `Image` 文件。如果 `tools/build` 本身编译失败，整个构建过程将中断。确保 `gcc-4.8` 能够成功编译 `tools/build.c`。如果出现链接错误，检查 `binutils` 是否完整安装。

### 内存布局错误
`include/linux/config.h` 文件定义了内核的内存布局，如 `HIGH_MEMORY` 和 `ROOT_DEV`。如果这些配置与实际硬件不匹配，内核可能无法正确初始化。例如，`HIGH_MEMORY` 设置为 `0x800000` (8MB)，如果系统内存不足，可能导致问题。根据 `README` 的说明，需要根据硬件修改此文件。

### 构建脚本权限
`tools/build` 程序在 `Makefile` 中被 `chmem` 命令修改内存限制。如果 `chmem` 不可用或执行失败，`tools/build` 可能无法处理较大的内核映像。确保 `chmem` 已安装，或在 `Makefile` 中注释掉 `chmem` 行进行测试。

**Section sources**
- [boot/boot.s](file://boot/boot.s#L298-L305)
- [tools/build.c](file://tools/build.c#L60-L68)
- [include/linux/config.h](file://include/linux/config.h#L7-L12)
- [Makefile](file://Makefile#L90)

## 结论
成功构建 Linux-0.01 内核的关键在于精确复现其原始的开发环境。这要求使用 `gcc-4.8` 配合 `-fno-stack-protector` 和 `-fno-builtin` 等特定标志来禁用现代编译器的安全特性，并使用 `i686-linux-gnu-as` 和 `i686-linux-gnu-ld` 交叉编译工具链来确保生成正确的 32 位代码。`-m32` 标志对于在 64 位主机上进行 32 位编译是必不可少的。通过在现代 Linux 发行版上安装指定的工具包，可以成功搭建兼容的构建环境。理解这些要求不仅是为了编译一个历史版本，更是深入理解操作系统底层开发与工具链演进的重要实践。